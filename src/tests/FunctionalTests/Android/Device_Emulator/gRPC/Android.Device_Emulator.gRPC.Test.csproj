<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TestRuntime>true</TestRuntime>
    <TargetFramework>$(NetCoreAppCurrent)</TargetFramework>
    <MainLibraryFileName>Android.Device_Emulator.gRPC.Test.dll</MainLibraryFileName>
    <ExpectedExitCode>42</ExpectedExitCode>

    <MonoForceInterpreter>false</MonoForceInterpreter>
    <RunAOTCompilation>true</RunAOTCompilation>
    <ForceAOT>true</ForceAOT>
    <AOTWithLibraryFiles>true</AOTWithLibraryFiles>

    <PublishTrimmed>true</PublishTrimmed>
    <EnableAggressiveTrimming>true</EnableAggressiveTrimming>
    
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <!-- Disable CS8981 because the generated code from the protobuf files contains classes with lowercase names -->
    <!-- Disable SYSLIB0039 because the tests intentionally use TLS 1.0 and 1.1 -->
    <NoWarn>CS8981;SYSLIB0039</NoWarn>
  </PropertyGroup>

  <PropertyGroup>
    <IncludeNetworkSecurityConfig>true</IncludeNetworkSecurityConfig>
  </PropertyGroup>

  <ItemGroup>
    <Compile Include="Program.cs" />

    <None Include="$(MSBuildProjectDirectory)\res\**\*">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
  </ItemGroup>

  <!-- Based on grpc-dotnet's testassets/InteropTestsClient/InteropTestsClient.csproj -->
  <ItemGroup>
    <!-- Required for QUIC & HTTP/3 in .NET 6 - https://github.com/dotnet/runtime/pull/55332 -->
    <RuntimeHostConfigurationOption Include="System.Net.SocketsHttpHandler.Http3Support" Value="true" />

    <Compile Include="$(MSBuildProjectDirectory)\grpc-dotnet\testassets\Shared\*.cs" />
    <Compile Include="$(MSBuildProjectDirectory)\grpc-dotnet\test\Shared\HttpEventSourceListener.cs" />

    <Protobuf
      Include="$(MSBuildProjectDirectory)\grpc-dotnet\testassets\Proto\grpc\testing\*.proto"
      ProtoRoot="$(MSBuildProjectDirectory)\grpc-dotnet\testassets\Proto\grpc\testing\"
      GrpcServices="Client" />

    <PackageReference Include="Grpc.Auth" Version="2.47.0" />
    <PackageReference Include="Grpc.Net.Client" Version="2.47.0" />
    <PackageReference Include="Grpc.Net.Client.Web" Version="2.47.0" />

    <PackageReference Include="Google.Protobuf" Version="3.19.4" />
    <PackageReference Include="Grpc.Core" Version="2.46.3" PrivateAssets="All" />
    <PackageReference Include="Grpc.Tools" Version="2.48.0-pre1" PrivateAssets="All" />
    <PackageReference Include="Microsoft.Extensions.Logging" Version="3.0.3" />
    <PackageReference Include="System.CommandLine" Version="2.0.0-beta3.22114.1" />
  </ItemGroup>

  <Target Name="BuildServerDockerImage" AfterTargets="Build" Condition="'$(BuildGrpcServerDockerImage)' == 'true'">
    <Exec Command="docker build -t grpc-server:latest grpc-dotnet/testassets/" />
    <Exec Command="mkdir -p $(ArtifactsObjDir)/grpcserver/docker/" />
    <Exec Command="docker save -o $(ArtifactsObjDir)/grpcserver/docker/grpcserver.tar grpc-server:latest" />
  </Target>
</Project>
